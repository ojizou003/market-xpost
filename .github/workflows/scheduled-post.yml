name: Scheduled Market Post

on:
  schedule:
    # 日本時間 月～金 11:20 (UTC 02:20)
    - cron: '20 2 * * 1-5'
  workflow_dispatch: # 手動実行も可能にする

jobs:
  post-to-x:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # タイムアウトを30分に設定
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
    
    - name: Install dependencies
      run: uv sync
    
    - name: Set up Chrome and ChromeDriver
      uses: browser-actions/setup-chrome@latest
      with:
        chrome-version: stable
    
    - name: Restore cookies.pkl from secrets
      env:
        COOKIES_BASE64: ${{ secrets.COOKIES_PKL_BASE64 }}
      run: |
        if [ -z "$COOKIES_BASE64" ]; then
          echo "Error: COOKIES_PKL_BASE64 secret is not set"
          exit 1
        fi
        echo "$COOKIES_BASE64" | base64 -d > cookies.pkl
    
    - name: Run market post script
      env:
        CI: true  # CI環境であることを明示
      run: |
        uv run python x-market.py
    
    - name: Clean up cookies file
      if: always()
      run: |
        rm -f cookies.pkl

